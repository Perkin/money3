import{r as ge,a as we}from"./react.CvRECnwm.js";import{o as xe,y as m,r as f,L as _e,m as je}from"./vendor.DOUekRLu.js";(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function r(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(n){if(n.ep)return;n.ep=!0;const a=r(n);fetch(n.href,a)}})();var z={exports:{}},P={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var te;function Ie(){if(te)return P;te=1;var e=ge(),s=Symbol.for("react.element"),r=Symbol.for("react.fragment"),o=Object.prototype.hasOwnProperty,n=e.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,a={key:!0,ref:!0,__self:!0,__source:!0};function i(u,c,p){var l,d={},h=null,y=null;p!==void 0&&(h=""+p),c.key!==void 0&&(h=""+c.key),c.ref!==void 0&&(y=c.ref);for(l in c)o.call(c,l)&&!a.hasOwnProperty(l)&&(d[l]=c[l]);if(u&&u.defaultProps)for(l in c=u.defaultProps,c)d[l]===void 0&&(d[l]=c[l]);return{$$typeof:s,type:u,key:h,ref:y,props:d,_owner:n.current}}return P.Fragment=r,P.jsx=i,P.jsxs=i,P}var se;function be(){return se||(se=1,z.exports=Ie()),z.exports}var t=be(),T={},oe;function Se(){if(oe)return T;oe=1;var e=we();return T.createRoot=e.createRoot,T.hydrateRoot=e.hydrateRoot,T}var De=Se();class A extends Error{}A.prototype.name="InvalidTokenError";function Ne(e){return decodeURIComponent(atob(e).replace(/(.)/g,(s,r)=>{let o=r.charCodeAt(0).toString(16).toUpperCase();return o.length<2&&(o="0"+o),"%"+o}))}function ke(e){let s=e.replace(/-/g,"+").replace(/_/g,"/");switch(s.length%4){case 0:break;case 2:s+="==";break;case 3:s+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return Ne(s)}catch{return atob(s)}}function ne(e,s){if(typeof e!="string")throw new A("Invalid token specified: must be a string");s||(s={});const r=s.header===!0?0:1,o=e.split(".")[r];if(typeof o!="string")throw new A(`Invalid token specified: missing part #${r+1}`);let n;try{n=ke(o)}catch(a){throw new A(`Invalid token specified: invalid base64 for part #${r+1} (${a.message})`)}try{return JSON.parse(n)}catch(a){throw new A(`Invalid token specified: invalid json for part #${r+1} (${a.message})`)}}const Ee={DB_NAME:"money",DB_VERSION:1},{DB_NAME:Ce,DB_VERSION:Re}=window.DB_CONFIG||Ee;let J=null;async function I(){return J||(J=await xe(Ce,Re,{upgrade(e,s,r,o){let n;e.objectStoreNames.contains("invests")?n=o.objectStore("invests"):(n=e.createObjectStore("invests",{keyPath:"id",autoIncrement:!0}),n.createIndex("isActiveIdx","isActive",{unique:!1}),n.createIndex("updatedAtIdx","updatedAt",{unique:!1}));let a;e.objectStoreNames.contains("payments")?a=o.objectStore("payments"):(a=e.createObjectStore("payments",{keyPath:"id",autoIncrement:!0}),a.createIndex("investIdIdx","investId",{unique:!1}),a.createIndex("updatedAtIdx","updatedAt",{unique:!1})),a&&!a.indexNames.contains("isPayedIdx")&&a.createIndex("isPayedIdx","isPayed",{unique:!1})},blocked(){console.log("База данных заблокирована другой вкладкой")},blocking(){console.log("Эта вкладка блокирует обновление базы данных в другой вкладке")},terminated(){console.log("База данных была неожиданно закрыта")}})),J}async function B(e={}){const o=(await I()).transaction("payments").objectStore("payments");return e.id!==void 0?o.index("investIdIdx").getAll(e.id):e.updatedAt!==void 0?o.index("updatedAtIdx").getAll(IDBKeyRange.lowerBound(e.updatedAt)):e.isPayed!==void 0?o.index("isPayedIdx").getAll(e.isPayed):o.getAll()}async function Pe(e,s,r,o){const i=(await I()).transaction("payments","readwrite").objectStore("payments"),u={investId:e,money:Math.round(s*r),paymentDate:o,isPayed:0,updatedAt:new Date};return i.add(u)}async function de(e){const o=(await I()).transaction("payments","readwrite").objectStore("payments"),n=await o.get(e);if(!n)throw new Error("Payment not found");return n.isPayed=1,n.updatedAt=new Date,o.put(n)}async function Fe(e,s){const n=(await I()).transaction(["payments"],"readwrite").objectStore("payments"),a=await n.get(e);if(!a)throw new Error("Платеж не найден");const i={...a,...s,updatedAt:new Date},u=await n.put(i);return window.dispatchEvent(new CustomEvent("fetchInvests")),u}async function W(e={}){const o=(await I()).transaction("invests").objectStore("invests");return e.filterOnlyActive===1?o.index("isActiveIdx").getAll(1):e.updatedAt!==void 0?o.index("updatedAtIdx").getAll(IDBKeyRange.lowerBound(e.updatedAt)):o.getAll()}async function Ae(e,s,r){const a=(await I()).transaction("invests","readwrite").objectStore("invests"),i={money:e,incomeRatio:s,createdDate:r,closedDate:null,isActive:1,updatedAt:new Date};return a.add(i)}async function Be(e){const o=(await I()).transaction("invests","readwrite").objectStore("invests"),n=await o.get(e);if(!n)throw new Error("Invest not found");return n.isActive=0,n.closedDate=new Date,n.updatedAt=new Date,o.put(n)}async function $e(e,s){const r=s.money!==void 0?await B({id:e,isPayed:0}):[],n=(await I()).transaction(["invests","payments"],"readwrite"),a=n.objectStore("invests"),i=await a.get(e);if(!i)throw new Error("Инвестиция не найдена");const u={...i,...s,updatedAt:new Date};if(await a.put(u),s.money!==void 0){const c=n.objectStore("payments");for(const p of r){const l={...p,money:s.money*(i.incomeRatio||X),updatedAt:new Date};await c.put(l)}}return await n.done,window.dispatchEvent(new CustomEvent("fetchInvests")),e}const Q="https://perkin.alwaysdata.net/money/api";class M extends Error{constructor(s,r,o){super(s),this.status=r,this.statusText=o,this.name="ApiError"}}const re={retries:3,retryDelay:1e3};async function ue(e,s={}){const{retries:r=re.retries,retryDelay:o=re.retryDelay,...n}=s;let a=null;for(let i=0;i<=r;i++)try{const u=localStorage.getItem("token");if(!u)throw new M("Токен не найден",401);const c=await fetch(Q+e,{...n,headers:{"Content-Type":"application/json",Authorization:`Bearer ${u}`,...n.headers}});if(!c.ok){const l=new M(`HTTP ошибка: ${c.status}`,c.status,c.statusText);throw c.status===401?(m.error("Сессия истекла. Пожалуйста, авторизуйтесь заново"),l):(c.status<500&&c.status!==429,l)}return await c.json()}catch(u){if(a=u,i===r||u instanceof M&&u.status&&u.status<500&&u.status!==429){const c=u instanceof M?u.message:"Произошла сетевая ошибка";throw m.error(c),u}await new Promise(c=>setTimeout(c,o*(i+1)))}throw a||new Error("Неизвестная ошибка")}async function qe(e,s={}){return ue(e,{method:"GET",...s})}async function Te(e,s,r={}){return ue(e,{method:"POST",body:JSON.stringify(s),...r})}const X=.05;async function me(){const e=await W({filterOnlyActive:1});if(e.length)for(const s of e){let r=s.createdDate;const n=[...await B({id:s.id})].sort((v,g)=>v.paymentDate.getTime()-g.paymentDate.getTime()),a=n.length>0?n[n.length-1]:null;if(a&&!a.isPayed)continue;a&&(r=a.paymentDate);const i=s.createdDate.getDate(),u=r.getMonth(),c=r.getFullYear();let p=u+1,l=c;p>11&&(p=0,l+=1);const d=new Date(l,p+1,0).getDate(),h=i>d?d:i,y=new Date(l,p,h,0,0,0,0);await Pe(s.id,s.money,s.incomeRatio||X,y)}}async function fe(e,s=!1){const o=(await I()).transaction(["invests","payments"],"readwrite"),n=o.objectStore("invests"),a=o.objectStore("payments");s&&(await n.clear(),await a.clear());for(const i of e.invests){const u={...i,createdDate:new Date(i.createdDate),updatedAt:new Date(i.updatedAt),closedDate:i.closedDate?new Date(i.closedDate):void 0};await n.put(u)}for(const i of e.payments){const u={...i,paymentDate:new Date(i.paymentDate),updatedAt:new Date(i.updatedAt)};await a.put(u)}}async function Me(){const e=await W(),s=await B(),r=JSON.stringify({invests:e,payments:s});try{await navigator.clipboard.writeText(r),m.success("Данные скопированы в буфер обмена")}catch{m.error("Не удалось скопировать данные в буфер обмена")}}async function pe(){if(!localStorage.getItem("token"))return;const e=localStorage.getItem("lastSyncDate")||"";m.info("Получаю обновления...");const s=await qe(`/updates?since=${e}`);if(s.status==="success"){const r={invests:s.invests||[],payments:s.payments||[]};await fe(r),m.success("Обновления успешно применены"),window.dispatchEvent(new CustomEvent("fetchInvests"))}else s.status==="no_updates"?m.info("Обновлений нет"):m.warn(s.status);localStorage.setItem("lastSyncDate",new Date().toISOString())}async function $(){if(!localStorage.getItem("token"))return;const e=localStorage.getItem("lastSyncDate");let s={},r={};e&&(s={updatedAt:new Date(e)},r={updatedAt:new Date(e)});const o=await W(s),n=await B(r);if(!o.length&&!n.length)return;const a={invests:o,payments:n},i=m.info("Отправляю данные...",{autoClose:!1});try{const u=await Te("/update",a);m.done(i),u.status==="success"&&m.success("Новые данные успешно отправлены на сервер")}catch{m.done(i)}}const ye=f.createContext(void 0),Le=({children:e})=>{const[s,r]=f.useState(null),o=a=>{localStorage.setItem("token",a);const i=ne(a);r(i)},n=()=>{localStorage.removeItem("token"),r(null)};return f.useEffect(()=>{const a=localStorage.getItem("token");if(a)try{const i=ne(a);r(i)}catch(i){console.error("Ошибка при декодировании JWT",i),n()}},[]),f.useEffect(()=>{s&&pe().then(()=>{window.dispatchEvent(new CustomEvent("fetchInvests"))}).catch(a=>{console.error("Ошибка при синхронизации:",a)})},[s]),t.jsx(ye.Provider,{value:{user:s,login:o,logout:n},children:e})},U=()=>{const e=f.useContext(ye);if(!e)throw new Error("useUser должен использоваться внутри UserProvider");return e},Oe="_menuContainer_1544v_1",Ge="_menuButton_1544v_8",We="_menuDropdownContent_1544v_16",V={menuContainer:Oe,menuButton:Ge,menuDropdownContent:We},Ue="_menuButton_nj68m_1",ze={menuButton:Ue},N=({onClick:e,children:s})=>t.jsx("button",{className:ze.menuButton,type:"button",onClick:e,children:s}),Je="_userName_1mfy7_1",Ve={userName:Je},Ye=()=>{const{user:e}=U();return t.jsx("div",{className:Ve.userName,children:e?e.username:""})},He="_importForm_1loee_1",Ke="_formGroup_1loee_15",Ze="_errorInput_1loee_40",Qe="_errorText_1loee_44",Xe="_formActions_1loee_50",Y={importForm:He,formGroup:Ke,errorInput:Ze,errorText:Qe,formActions:Xe},et=({onSuccess:e})=>{const[s,r]=f.useState(""),o=async n=>{n.preventDefault();const a=s.trim();try{const i=JSON.parse(a);await fe(i,!0),m.success("Импорт завершен"),e(),window.dispatchEvent(new CustomEvent("fetchInvests"))}catch{m.error("Не удалось распарсить данные")}};return t.jsxs("form",{className:Y.importForm,onSubmit:o,children:[t.jsx("h2",{children:"Импорт"}),t.jsxs("div",{className:Y.formGroup,children:[t.jsx("label",{htmlFor:"import-string",children:"JSON:"}),t.jsx("textarea",{rows:10,id:"import-string",value:s,onChange:n=>r(n.target.value),required:!0})]}),t.jsx("div",{className:Y.formActions,children:t.jsx("button",{type:"submit",children:"Импортировать"})})]})},tt="_overlay_skzxb_1",st="_popup_skzxb_14",ae={overlay:tt,popup:st},E=({children:e,onClose:s})=>(f.useEffect(()=>{const r=o=>{o.key==="Escape"&&s()};return document.addEventListener("keydown",r),()=>document.removeEventListener("keydown",r)},[s]),t.jsx("div",{className:ae.overlay,onClick:s,children:t.jsx("div",{className:ae.popup,onClick:r=>r.stopPropagation(),children:e})})),ot="_loginForm_1vymo_1",nt="_formGroup_1vymo_15",rt="_errorInput_1vymo_38",at="_errorText_1vymo_42",it="_formActions_1vymo_48",S={loginForm:ot,formGroup:nt,errorInput:rt,errorText:at,formActions:it},ct=({onSuccess:e})=>{const{login:s}=U(),[r,o]=f.useState(""),[n,a]=f.useState(""),[i,u]=f.useState({}),c=async l=>{if(l.preventDefault(),u({}),!r||!n){m.error("Заполните все поля");return}try{const d=await fetch(`${Q}/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:r,password:n})});if(!d.ok){const y=await d.json();if(y.error==="invalid_credentials"){m.error("Неверный email или пароль");return}if(y.error==="validation_errors"){u(y.errors);return}throw new Error(y.message||"Ошибка при входе")}const{token:h}=await d.json();s(h),m.success("Вход выполнен успешно"),e()}catch(d){m.error(`Ошибка: ${d instanceof Error?d.message:"Неизвестная ошибка"}`)}},p=l=>{var d;return((d=i[l])==null?void 0:d.length)>0?i[l][0]:""};return t.jsxs("form",{className:S.loginForm,onSubmit:c,children:[t.jsx("h2",{children:"Вход"}),t.jsxs("div",{className:S.formGroup,children:[t.jsx("label",{htmlFor:"email",children:"Email:"}),t.jsx("input",{type:"email",id:"email",value:r,onChange:l=>o(l.target.value),className:i.email?S.errorInput:"",required:!0}),p("email")&&t.jsx("div",{className:S.errorText,children:p("email")})]}),t.jsxs("div",{className:S.formGroup,children:[t.jsx("label",{htmlFor:"password",children:"Пароль:"}),t.jsx("input",{type:"password",id:"password",value:n,onChange:l=>a(l.target.value),className:i.password?S.errorInput:"",required:!0}),p("password")&&t.jsx("div",{className:S.errorText,children:p("password")})]}),t.jsx("div",{className:S.formActions,children:t.jsx("button",{type:"submit",children:"Войти"})})]})},lt="_registerForm_4l4og_1",dt="_formGroup_4l4og_15",ut="_errorInput_4l4og_38",mt="_errorText_4l4og_42",ft="_formActions_4l4og_48",x={registerForm:lt,formGroup:dt,errorInput:ut,errorText:mt,formActions:ft},pt=({onSuccess:e})=>{const{login:s}=U(),[r,o]=f.useState(""),[n,a]=f.useState(""),[i,u]=f.useState(""),[c,p]=f.useState(""),[l,d]=f.useState({}),h=async v=>{if(v.preventDefault(),d({}),!r||!n||!i||!c){m.error("Заполните все поля");return}if(i!==c){d({confirmPassword:["Пароли не совпадают"]});return}try{const g=await fetch(`${Q}/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:r,username:n,password:i})});if(!g.ok){const b=await g.json();if(b.error==="user_exists"){m.error("Такой пользователь уже существует");return}if(b.error==="validation_errors"){d(b.errors);return}throw new Error(b.message||"Ошибка при регистрации")}const{token:C}=await g.json();s(C),m.success("Регистрация выполнена успешно"),e()}catch(g){m.error(`Ошибка: ${g instanceof Error?g.message:"Неизвестная ошибка"}`)}},y=v=>{var g;return((g=l[v])==null?void 0:g.length)>0?l[v][0]:""};return t.jsxs("form",{className:x.registerForm,onSubmit:h,children:[t.jsx("h2",{children:"Регистрация"}),t.jsxs("div",{className:x.formGroup,children:[t.jsx("label",{htmlFor:"email",children:"Email:"}),t.jsx("input",{type:"email",id:"email",value:r,onChange:v=>o(v.target.value),className:l.email?x.errorInput:"",required:!0}),y("email")&&t.jsx("div",{className:x.errorText,children:y("email")})]}),t.jsxs("div",{className:x.formGroup,children:[t.jsx("label",{htmlFor:"username",children:"Имя пользователя:"}),t.jsx("input",{type:"text",id:"username",value:n,onChange:v=>a(v.target.value),className:l.username?x.errorInput:"",required:!0}),y("username")&&t.jsx("div",{className:x.errorText,children:y("username")})]}),t.jsxs("div",{className:x.formGroup,children:[t.jsx("label",{htmlFor:"password",children:"Пароль:"}),t.jsx("input",{type:"password",id:"password",value:i,onChange:v=>u(v.target.value),className:l.password?x.errorInput:"",required:!0}),y("password")&&t.jsx("div",{className:x.errorText,children:y("password")})]}),t.jsxs("div",{className:x.formGroup,children:[t.jsx("label",{htmlFor:"confirmPassword",children:"Подтвердите пароль:"}),t.jsx("input",{type:"password",id:"confirmPassword",value:c,onChange:v=>p(v.target.value),className:l.confirmPassword?x.errorInput:"",required:!0}),y("confirmPassword")&&t.jsx("div",{className:x.errorText,children:y("confirmPassword")})]}),t.jsx("div",{className:x.formActions,children:t.jsx("button",{type:"submit",children:"Зарегистрироваться"})})]})},yt="_settingsForm_1iuzq_1",ht="_formGroup_1iuzq_15",vt="_buttonGroup_1iuzq_38",gt="_saveButton_1iuzq_44",wt="_logoutButton_1iuzq_44",xt="_confirmButton_1iuzq_44",_t="_cancelButton_1iuzq_44",jt="_settingsButton_1iuzq_44",It="_testButton_1iuzq_44",bt="_confirmLogout_1iuzq_71",St="_notificationStatus_1iuzq_100",Dt="_notificationButtons_1iuzq_108",Nt="_appInfoBlock_1iuzq_148",kt="_appInfoRow_1iuzq_156",Et="_appInfoLabel_1iuzq_166",Ct="_appInfoValue_1iuzq_171",Rt="_cleanupButton_1iuzq_176",w={settingsForm:yt,formGroup:ht,buttonGroup:vt,saveButton:gt,logoutButton:wt,confirmButton:xt,cancelButton:_t,settingsButton:jt,testButton:It,confirmLogout:bt,notificationStatus:St,notificationButtons:Dt,appInfoBlock:Nt,appInfoRow:kt,appInfoLabel:Et,appInfoValue:Ct,cleanupButton:Rt},ie=async(e=!1)=>{if(!("Notification"in window)){console.error("Уведомления не поддерживаются");return}if(Notification.permission!=="granted"){console.log("Нет разрешения на отправку уведомлений");return}try{if("serviceWorker"in navigator)try{const s=await navigator.serviceWorker.ready;if(s.active){s.active.postMessage({type:"check-debts",force:e}),console.log("Запрос на проверку долгов отправлен через Service Worker");return}}catch(s){console.warn("Service Worker не активен, используем обычные уведомления:",s)}new Notification(e?"Принудительная проверка долгов":"Проверка долгов",{body:"Уведомления о долгах работают",icon:"/money3/icon-192x192.png"}),console.log("Запрос на проверку долгов выполнен через обычные уведомления")}catch(s){console.error("Ошибка при проверке долгов:",s)}},Pt=async()=>{if(!("Notification"in window))return console.error("Уведомления не поддерживаются"),!1;try{return await Notification.requestPermission()==="granted"}catch(e){return console.error("Ошибка при запросе разрешения на уведомления:",e),!1}},Ft="1.0.4",At="2025-04-12T23:54:36.765Z",Bt=()=>{const[e,s]=f.useState(Notification.permission||"default"),r=async()=>{await Pt()?(s("granted"),m.success("Разрешение на уведомления получено"),await ie()):(s("denied"),m.error("Разрешение на уведомления не получено"))},o=async()=>{await ie(!0),m.info("Запрос на проверку долгов отправлен")},n=async()=>{try{if(!("serviceWorker"in navigator)){localStorage.removeItem("notificationState"),m.success("История уведомлений очищена");return}const i=await navigator.serviceWorker.ready;i.active?(i.active.postMessage({type:"cleanup-notifications"}),m.success("Запрос на очистку истории уведомлений отправлен")):(localStorage.removeItem("notificationState"),m.success("История уведомлений очищена"))}catch(i){console.error("Ошибка при очистке истории уведомлений:",i),m.error("Не удалось очистить историю уведомлений")}},a=new Date(At).toLocaleString("ru-RU",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"});return t.jsxs("div",{className:w.settingsForm,children:[t.jsx("h2",{children:"Настройки"}),t.jsxs("div",{className:w.formGroup,children:[t.jsx("label",{children:"Управление уведомлениями"}),t.jsxs("div",{className:w.notificationStatus,children:["Статус: ",e==="granted"?"Разрешены":e==="denied"?"Заблокированы":"Не запрошены"]}),t.jsxs("div",{className:w.notificationButtons,children:[t.jsx("button",{onClick:r,disabled:e==="denied",className:w.settingsButton,children:e==="granted"?"Уведомления разрешены":"Разрешить уведомления"}),e==="granted"&&t.jsxs(t.Fragment,{children:[t.jsx("button",{onClick:o,className:w.testButton,children:"Проверить долги"}),t.jsx("button",{onClick:n,className:w.cleanupButton,children:"Очистить историю уведомлений"})]})]})]}),t.jsxs("div",{className:w.formGroup,children:[t.jsx("label",{children:"О приложении"}),t.jsxs("div",{className:w.appInfoBlock,children:[t.jsxs("div",{className:w.appInfoRow,children:[t.jsx("span",{className:w.appInfoLabel,children:"Версия:"}),t.jsx("span",{className:w.appInfoValue,children:Ft})]}),t.jsxs("div",{className:w.appInfoRow,children:[t.jsx("span",{className:w.appInfoLabel,children:"Дата сборки:"}),t.jsx("span",{className:w.appInfoValue,children:a})]})]})]})]})},$t=()=>{const{user:e,logout:s}=U(),[r,o]=f.useState(!1),n=f.useRef(null),a=f.useRef(null);f.useEffect(()=>{const _=q=>{a.current&&!a.current.contains(q.target)&&n.current&&!n.current.contains(q.target)&&o(!1)};return document.addEventListener("click",_),()=>{document.removeEventListener("click",_)}},[]);const i=_=>{_.stopPropagation(),o(q=>!q)},[u,c]=f.useState(!1),[p,l]=f.useState(!1),[d,h]=f.useState(!1),[y,v]=f.useState(!1),g=async()=>{try{await Me(),m.success("Данные успешно экспортированы")}catch(_){m.error(`Ошибка экспорта: ${_ instanceof Error?_.message:"Неизвестная ошибка"}`)}},C=()=>{o(!1),c(!0)},b=()=>{o(!1),v(!0)},R=async()=>{try{localStorage.setItem("lastSyncDate",""),await pe(),m.success("Данные успешно синхронизированы")}catch(_){m.error(`Ошибка синхронизации: ${_ instanceof Error?_.message:"Неизвестная ошибка"}`)}},ve=()=>{s(),m.success("Вы успешно вышли")};return t.jsxs("div",{className:V.menuContainer,children:[t.jsx(Ye,{}),t.jsx("button",{className:V.menuButton,ref:n,onClick:i,children:"☰"}),r&&t.jsxs("div",{className:V.menuDropdownContent,ref:a,children:[t.jsx(N,{onClick:g,children:"Экспорт"}),t.jsx(N,{onClick:C,children:"Импорт"}),t.jsx(N,{onClick:b,children:"Настройки"}),e?t.jsxs(t.Fragment,{children:[t.jsx(N,{onClick:R,children:"Обновить данные"}),t.jsx(N,{onClick:ve,children:"Выход"})]}):t.jsxs(t.Fragment,{children:[t.jsx(N,{onClick:()=>h(!0),children:"Регистрация"}),t.jsx(N,{onClick:()=>l(!0),children:"Авторизация"})]})]}),p&&t.jsx(E,{onClose:()=>l(!1),children:t.jsx(ct,{onSuccess:()=>{l(!1),o(!1)}})}),d&&t.jsx(E,{onClose:()=>h(!1),children:t.jsx(pt,{onSuccess:()=>{h(!1),o(!1)}})}),y&&t.jsx(E,{onClose:()=>v(!1),children:t.jsx(Bt,{})}),u&&t.jsx(E,{onClose:()=>c(!1),children:t.jsx(et,{onSuccess:()=>c(!1)})})]})},qt="_addInvestForm_xb664_1",Tt="_moneyRow_xb664_5",Mt="_dateRow_xb664_27",Lt="_buttonRow_xb664_37",L={addInvestForm:qt,moneyRow:Tt,dateRow:Mt,buttonRow:Lt},Ot=()=>{const e=f.useRef(null),[s,r]=f.useState(0),[o,n]=f.useState(.025),[a,i]=f.useState(),u=async c=>{var p;if(c.preventDefault(),!s||!o||!a){m.error("Заполните все поля");return}a.setHours(0,0,0);try{const l=await Ae(s,o,a);Number.isInteger(l)?(await me(),await $(),(p=e.current)==null||p.reset(),m.success("Инвестиция добавлена"),window.dispatchEvent(new CustomEvent("fetchInvests"))):m.error("Не удалось добавить инвестицию")}catch(l){m.error(`Ошибка: ${l instanceof Error?l.message:"Неизвестная ошибка"}`)}};return t.jsxs("form",{className:L.addInvestForm,ref:e,onSubmit:u,children:[t.jsxs("div",{className:L.moneyRow,children:[t.jsx("input",{type:"text",placeholder:"Сколько инвестируем",onChange:c=>r(parseFloat(c.target.value)),required:!0}),t.jsxs("select",{onChange:c=>n(parseFloat(c.target.value)),required:!0,children:[t.jsx("option",{value:"0.025",children:"2.5%"}),t.jsx("option",{value:"0.05",children:"5%"})]})]}),t.jsx("div",{className:L.dateRow,children:t.jsx("input",{type:"date",placeholder:"Дата инвестиции",onChange:c=>i(new Date(c.target.value)),onClick:c=>c.currentTarget.showPicker(),required:!0})}),t.jsx("div",{className:L.buttonRow,children:t.jsx("button",{type:"submit",children:"Добавить"})})]})},Gt="_dataFilter_1s026_1",Wt="_filterItem_1s026_6",H={dataFilter:Gt,filterItem:Wt},Ut=({activeFilter:e,setActiveFilter:s,showPayed:r,setShowPayed:o})=>t.jsxs("div",{className:H.dataFilter,children:[t.jsx("div",{className:H.filterItem,children:t.jsxs("label",{children:[t.jsx("input",{type:"checkbox",checked:e,onChange:()=>s(!e)}),"С закрытыми"]})}),t.jsx("div",{className:H.filterItem,children:t.jsxs("label",{children:[t.jsx("input",{type:"checkbox",checked:r,onChange:()=>o(!r)}),"С оплаченными"]})})]}),zt="_dataList_5dlll_1",Jt="_dataItem_5dlll_7",ce={dataList:zt,dataItem:Jt},Vt="_dataItem_1wxo7_1",Yt="_even_1wxo7_12",Ht="_closed_1wxo7_16",Kt="_itemMoney_1wxo7_20",Zt="_itemActions_1wxo7_24",Qt="_investCloseButton_1wxo7_30",Xt="_investEditButton_1wxo7_31",k={dataItem:Vt,even:Yt,closed:Ht,itemMoney:Kt,itemActions:Zt,investCloseButton:Qt,investEditButton:Xt},es="_dataItem_13v5n_1",ts="_emptyCell_13v5n_10",ss="_even_13v5n_14",os="_debt_13v5n_18",ns="_payed_13v5n_22",rs="_itemMoney_13v5n_26",as="_itemActions_13v5n_30",is="_paymentCloseButton_13v5n_36",cs="_paymentEditButton_13v5n_37",j={dataItem:es,emptyCell:ts,even:ss,debt:os,payed:ns,itemMoney:rs,itemActions:as,paymentCloseButton:is,paymentEditButton:cs},ls=new Intl.NumberFormat("default",{style:"currency",currency:"RUB",useGrouping:!0,maximumSignificantDigits:9,currencyDisplay:"symbol"}),Z=e=>{if(!e)return"";if(!(e instanceof Date))return e;let s=e.getFullYear()+"",r=e.toLocaleString("default",{month:"short"}).replace(".",""),o=e.getDate()+"";return e.getDate()<10&&(o="0"+o),`${s}-${r}-${o}`},ee=e=>ls.format(e).replace(/RUB\s*([0-9,.-]+)/,"$1 ₽"),ds="_editPaymentForm_17xt4_1",us="_formRow_17xt4_9",ms="_buttonRow_17xt4_37",F={editPaymentForm:ds,formRow:us,buttonRow:ms},fs=e=>{const s=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0");return`${s}-${r}-${o}`},ps=({payment:e,onClose:s})=>{const r=f.useRef(null),[o,n]=f.useState(e.money),[a,i]=f.useState(e.paymentDate),[u,c]=f.useState(e.isPayed),p=async l=>{if(l.preventDefault(),!o||o<=0||!a){m.error("Заполните все поля");return}try{await Fe(e.id,{money:o,paymentDate:a,isPayed:u}),await $(),m.success("Платёж обновлен"),s()}catch(d){m.error(`Ошибка: ${d instanceof Error?d.message:"Неизвестная ошибка"}`)}};return t.jsxs("form",{className:F.editPaymentForm,ref:r,onSubmit:p,children:[t.jsxs("div",{className:F.formRow,children:[t.jsx("label",{children:"Сумма:"}),t.jsx("input",{type:"number",value:o,onChange:l=>n(parseFloat(l.target.value)),required:!0})]}),t.jsxs("div",{className:F.formRow,children:[t.jsx("label",{children:"Дата платежа:"}),t.jsx("input",{type:"date",value:fs(a),onChange:l=>{const d=l.target.value;if(d){const[h,y,v]=d.split("-"),g=parseInt(h,10),C=parseInt(y,10)-1,b=parseInt(v,10),R=new Date;R.setFullYear(g,C,b),R.setHours(0,0,0,0),i(R)}},required:!0})]}),t.jsxs("div",{className:F.formRow,children:[t.jsx("label",{children:"Статус:"}),t.jsxs("select",{value:u,onChange:l=>c(parseInt(l.target.value)),children:[t.jsx("option",{value:0,children:"Не оплачен"}),t.jsx("option",{value:1,children:"Оплачен"})]})]}),t.jsxs("div",{className:F.buttonRow,children:[t.jsx("button",{type:"submit",children:"Сохранить"}),t.jsx("button",{type:"button",onClick:s,children:"Отмена"})]})]})},ys=({payment:e,isEven:s,isDebt:r,onClosePayment:o})=>{const[n,a]=f.useState(!1),i=async u=>{try{const c=await de(u);Number.isInteger(c)&&c===u?(m.success("Долг оплачен"),await me(),o(),await $()):m.error("Не удалось оплатить платеж")}catch(c){m.error(`Ошибка: ${c instanceof Error?c.message:"Неизвестная ошибка"}`)}};return t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:`${j.dataItem} ${s?j.even:""} ${r?j.debt:""} ${e.isPayed==1?j.payed:""}`,children:[t.jsx("div",{className:j.emptyCell}),t.jsx("div",{children:Z(e.paymentDate)}),t.jsx("div",{className:j.itemMoney,children:ee(e.money)}),t.jsxs("div",{className:j.itemActions,children:[t.jsx("button",{className:j.paymentEditButton,title:"Редактировать платёж",onClick:()=>a(!0),children:"✎"}),e.isPayed==0&&t.jsx("button",{className:j.paymentCloseButton,title:"Оплата произведена",onClick:()=>i(e.id),children:"✓"})]})]}),n&&t.jsx(E,{onClose:()=>a(!1),children:t.jsx(ps,{payment:e,onClose:()=>{a(!1),o()}})})]})},hs="_editInvestForm_xk5rx_1",vs="_formRow_xk5rx_9",gs="_buttonRow_xk5rx_37",O={editInvestForm:hs,formRow:vs,buttonRow:gs},ws=e=>e.toISOString().split("T")[0],xs=({invest:e,onClose:s})=>{const r=f.useRef(null),[o,n]=f.useState(e.money),[a,i]=f.useState(e.createdDate),u=async c=>{if(c.preventDefault(),!o||!a){m.error("Заполните все поля");return}try{await $e(e.id,{money:o,createdDate:a}),await $(),m.success("Инвестиция обновлена"),s()}catch(p){m.error(`Ошибка: ${p instanceof Error?p.message:"Неизвестная ошибка"}`)}};return t.jsxs("form",{className:O.editInvestForm,ref:r,onSubmit:u,children:[t.jsxs("div",{className:O.formRow,children:[t.jsx("label",{htmlFor:"money-input",children:"Сумма:"}),t.jsx("input",{id:"money-input",type:"number",value:o,onChange:c=>n(parseFloat(c.target.value)),required:!0})]}),t.jsxs("div",{className:O.formRow,children:[t.jsx("label",{htmlFor:"date-input",children:"Дата создания:"}),t.jsx("input",{id:"date-input",type:"date",value:ws(a),onChange:c=>i(new Date(c.target.value)),required:!0})]}),t.jsxs("div",{className:O.buttonRow,children:[t.jsx("button",{type:"submit",children:"Сохранить"}),t.jsx("button",{type:"button",onClick:s,children:"Отмена"})]})]})},_s=({invest:e,isEven:s,payments:r,onRefreshData:o})=>{const n=new Date,[a,i]=f.useState(!1),u=async c=>{if(!(!c||!confirm("Точно закрыть?")))try{const p=await Be(c);if(Number.isInteger(p)&&p===c){for(const l of r)if(!l.isPayed&&l.id!==void 0)try{const d=await de(l.id);Number.isInteger(d)&&d===l.id?m.info("Долг автоматически оплачен"):m.error("Не удалось закрыть активный долг")}catch(d){m.error(`Ошибка: ${d instanceof Error?d.message:"Неизвестная ошибка"}`)}m.success("Инвестиция закрыта"),o(),await $()}else m.error("Не удалось закрыть инвестицию")}catch(p){m.error(`Ошибка: ${p instanceof Error?p.message:"Неизвестная ошибка"}`)}};return t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:`${k.dataItem} ${s?k.even:""} ${e.closedDate?k.closed:""}`,children:[t.jsx("div",{children:Z(e.createdDate)}),t.jsx("div",{children:Z(e.closedDate)}),t.jsxs("div",{className:k.itemMoney,children:[ee(e.money)," (",100*(e.incomeRatio||X),"%)"]}),t.jsx("div",{className:k.itemActions,children:e.isActive==1&&t.jsxs(t.Fragment,{children:[t.jsx("button",{className:k.investEditButton,title:"Редактировать инвестицию",onClick:()=>i(!0),children:"✎"}),t.jsx("button",{className:k.investCloseButton,title:"Закрыть инвестицию",onClick:()=>e.id!==void 0&&u(e.id),children:"✕"})]})})]}),a&&t.jsx(E,{onClose:()=>i(!1),children:t.jsx(xs,{invest:e,onClose:()=>{i(!1),o()}})}),r.map(c=>c.id!==void 0?t.jsx(ys,{payment:c,isEven:s,isDebt:!c.isPayed&&c.paymentDate<n,onClosePayment:o},c.id):null)]})},js="_curDateItem_70h4h_1",Is={curDateItem:js},le=()=>t.jsx("div",{className:Is.curDateItem}),bs="_dataItem_11qg2_1",Ss="_itemMoney_11qg2_12",Ds="_itemActions_11qg2_16",Ns="_debt_11qg2_22",G={dataItem:bs,itemMoney:Ss,itemActions:Ds,debt:Ns},K=({amount:e,title:s,isDebt:r=!1})=>t.jsxs("div",{className:`${G.dataItem} ${r?G.debt:""}`,children:[t.jsx("div",{children:s}),t.jsx("div",{}),t.jsx("div",{className:G.itemMoney,children:ee(e)}),t.jsx("div",{className:G.itemActions})]}),ks=({invests:e,showPayed:s})=>{const r=new Date,o=r.getDate(),[n,a]=f.useState({});f.useEffect(()=>{(async()=>{const d={};for(const h of e)if(h.id!==void 0){const v=(await B({id:h.id})).filter(g=>s||!g.isPayed);d[h.id]=v}a(d)})().catch(d=>{console.error("Ошибка при загрузке платежей:",d)})},[e,s]);const i=f.useMemo(()=>e.reduce((l,d)=>l+(d.isActive?d.money:0),0),[e]),u=f.useMemo(()=>e.reduce((l,d)=>l+(d.isActive?d.money*(d.incomeRatio||.05):0),0),[e]),c=f.useMemo(()=>{let l=0;return Object.entries(n).forEach(([,d])=>{d.forEach(h=>{!h.isPayed&&h.paymentDate<r&&(l+=h.money)})}),l},[n,r]),p=f.useMemo(()=>e.map((l,d)=>{const h=l.createdDate.getDate();let y=[];if(d===0&&h>=o&&y.push(t.jsx(le,{},"current-date-first")),l.id!==void 0){const v=n[l.id]||[];y.push(t.jsx(_s,{invest:l,isEven:d%2===0,payments:v,onRefreshData:()=>window.dispatchEvent(new CustomEvent("fetchInvests"))},l.id))}return d<e.length-1&&h<o&&e[d+1].createdDate.getDate()>=o&&y.push(t.jsx(le,{},"current-date-middle")),y}).flat(),[e,n,o]);return t.jsxs("div",{className:ce.dataList,children:[t.jsx("div",{children:t.jsxs("div",{className:ce.dataItem,children:[t.jsx("div",{children:"Создано"}),t.jsx("div",{children:"Закрыто/Оплата"}),t.jsx("div",{children:"Сумма"}),t.jsx("div",{children:"Действия"})]})}),t.jsxs("div",{children:[p,t.jsx(K,{title:"Итого",amount:i}),t.jsx(K,{title:"Прибыль",amount:u}),c>0&&t.jsx(K,{title:"Долг",amount:c,isDebt:!0})]})]})},Es="_container_1b0su_29",Cs={container:Es},Rs=()=>{const[e,s]=f.useState(!1),[r,o]=f.useState(!1),[n,a]=f.useState([]),i=f.useCallback(async()=>{const p=(await W({filterOnlyActive:e?0:1})).sort((l,d)=>{const h=l.createdDate.getDate(),y=d.createdDate.getDate();return h-y});a(p)},[e]);return f.useEffect(()=>(i().catch(u=>{console.error("Ошибка в fetchInvests:",u)}),window.addEventListener("fetchInvests",i),()=>window.removeEventListener("fetchInvests",i)),[i]),t.jsxs(Le,{children:[t.jsx(_e,{position:"top-center",closeButton:!1,autoClose:3e3,hideProgressBar:!1,newestOnTop:!0,transition:je,theme:"dark"}),t.jsxs("div",{className:Cs.container,children:[t.jsx("h1",{children:"Инвестиции"}),t.jsx($t,{}),t.jsx(Ot,{}),t.jsx(Ut,{activeFilter:e,setActiveFilter:s,showPayed:r,setShowPayed:o}),t.jsx(ks,{invests:n,showPayed:r})]})]})};function he(){document.body.classList.add("app-loaded"),console.log("Приложение загружено")}function D(e){const s=document.getElementById("app-loading-status");s&&(s.textContent=e)}const Ps=De.createRoot(document.getElementById("root"));Ps.render(t.jsx(f.StrictMode,{children:t.jsx(Rs,{})}));window.requestAnimationFrame(()=>{setTimeout(he,500)});"serviceWorker"in navigator&&navigator.serviceWorker.addEventListener("message",e=>{if(console.log("Получено сообщение от ServiceWorker:",e.data),e.data&&e.data.type==="get-notification-state")try{const s=localStorage.getItem("notificationState");let r=null;s&&(r=JSON.parse(s),console.log("Загружено состояние уведомлений из localStorage:",r)),navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage({type:"notification-state-from-client",state:r})}catch(s){console.error("Ошибка при загрузке состояния уведомлений из localStorage:",s)}else if(e.data&&e.data.type==="save-notification-state")try{const s=e.data.state;localStorage.setItem("notificationState",JSON.stringify(s)),console.log("Состояние уведомлений сохранено в localStorage:",s)}catch(s){console.error("Ошибка при сохранении состояния уведомлений в localStorage:",s)}else e.data&&e.data.type==="status"?D(e.data.message):e.data&&e.data.type==="activated"?(console.log("Service Worker активирован, версия:",e.data.version),he()):e.data&&e.data.type==="app-version"?console.log("Версия приложения:",e.data.version):e.data&&e.data.type==="error"?console.error("Ошибка Service Worker:",e.data.message):e.data&&e.data.type==="notification-shown"&&console.log(`Показано уведомление о ${e.data.count} долгах на сумму ${e.data.amount}`)});"serviceWorker"in navigator&&window.addEventListener("load",async()=>{var e,s,r;try{D("Регистрация Service Worker...");const o=await navigator.serviceWorker.register("/money3/service-worker.js",{updateViaCache:"none"});if(console.log("ServiceWorker успешно зарегистрирован:",o.scope),D("Service Worker зарегистрирован"),o.addEventListener("updatefound",()=>{const n=o.installing;n&&(console.log("Обнаружена новая версия ServiceWorker"),D("Обнаружена новая версия приложения"),n.addEventListener("statechange",()=>{n.state==="installed"&&navigator.serviceWorker.controller?(console.log("Новый Service Worker установлен и готов к использованию"),D("Обновление готово к установке"),confirm("Доступна новая версия приложения. Обновить сейчас?")&&(D("Применяю обновление..."),window.location.reload())):n.state==="installing"?D("Установка обновления..."):n.state==="activated"&&D("Обновление активировано")}))}),"Notification"in window){let n=Notification.permission;n!=="granted"&&n!=="denied"&&(n=await Notification.requestPermission()),console.log("Разрешение на уведомления:",n),n==="granted"&&setTimeout(()=>{try{!("serviceWorker"in navigator)||!o.active?new Notification("Money Debt готов к работе",{body:"Приложение успешно загружено",icon:"/money3/icon-192x192.png"}):o.active.postMessage({type:"check-debts",force:!1})}catch(a){console.error("Ошибка при отправке тестового уведомления:",a)}},3e3)}if(o.periodicSync)try{(await navigator.permissions.query({name:"periodic-background-sync"})).state==="granted"?(await o.periodicSync.register("check-debts",{minInterval:20*60*60*1e3}),console.log("Периодическая синхронизация успешно зарегистрирована")):(console.log("Нет разрешения на периодическую синхронизацию"),(e=o.active)==null||e.postMessage({type:"check-debts",force:!1}))}catch(n){console.error("Ошибка при регистрации периодической синхронизации:",n),(s=o.active)==null||s.postMessage({type:"check-debts",force:!1})}else if(console.log("Периодическая синхронизация не поддерживается"),(r=o.active)==null||r.postMessage({type:"check-debts",force:!1}),o.sync)try{await o.sync.register("check-debts"),console.log("Фоновая синхронизация успешно зарегистрирована")}catch(n){console.error("Ошибка при регистрации фоновой синхронизации:",n)}}catch(o){console.error("Ошибка при регистрации ServiceWorker:",o)}});
