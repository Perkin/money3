import{r as he,a as ve}from"./react.CvRECnwm.js";import{o as we,y as f,r as m,L as ge,m as xe}from"./vendor.DOUekRLu.js";(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function r(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(o){if(o.ep)return;o.ep=!0;const a=r(o);fetch(o.href,a)}})();var J={exports:{}},R={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var ee;function _e(){if(ee)return R;ee=1;var t=he(),s=Symbol.for("react.element"),r=Symbol.for("react.fragment"),n=Object.prototype.hasOwnProperty,o=t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,a={key:!0,ref:!0,__self:!0,__source:!0};function i(u,c,p){var l,d={},h=null,y=null;p!==void 0&&(h=""+p),c.key!==void 0&&(h=""+c.key),c.ref!==void 0&&(y=c.ref);for(l in c)n.call(c,l)&&!a.hasOwnProperty(l)&&(d[l]=c[l]);if(u&&u.defaultProps)for(l in c=u.defaultProps,c)d[l]===void 0&&(d[l]=c[l]);return{$$typeof:s,type:u,key:h,ref:y,props:d,_owner:o.current}}return R.Fragment=r,R.jsx=i,R.jsxs=i,R}var te;function je(){return te||(te=1,J.exports=_e()),J.exports}var e=je(),T={},se;function be(){if(se)return T;se=1;var t=ve();return T.createRoot=t.createRoot,T.hydrateRoot=t.hydrateRoot,T}var Ie=be();class k extends Error{}k.prototype.name="InvalidTokenError";function Se(t){return decodeURIComponent(atob(t).replace(/(.)/g,(s,r)=>{let n=r.charCodeAt(0).toString(16).toUpperCase();return n.length<2&&(n="0"+n),"%"+n}))}function De(t){let s=t.replace(/-/g,"+").replace(/_/g,"/");switch(s.length%4){case 0:break;case 2:s+="==";break;case 3:s+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return Se(s)}catch{return atob(s)}}function ne(t,s){if(typeof t!="string")throw new k("Invalid token specified: must be a string");s||(s={});const r=s.header===!0?0:1,n=t.split(".")[r];if(typeof n!="string")throw new k(`Invalid token specified: missing part #${r+1}`);let o;try{o=De(n)}catch(a){throw new k(`Invalid token specified: invalid base64 for part #${r+1} (${a.message})`)}try{return JSON.parse(o)}catch(a){throw new k(`Invalid token specified: invalid json for part #${r+1} (${a.message})`)}}const Ne={DB_NAME:"money",DB_VERSION:1},{DB_NAME:Ee,DB_VERSION:Ce}=window.DB_CONFIG||Ne;let W=null;async function j(){return W||(W=await we(Ee,Ce,{upgrade(t,s,r,n){let o;t.objectStoreNames.contains("invests")?o=n.objectStore("invests"):(o=t.createObjectStore("invests",{keyPath:"id",autoIncrement:!0}),o.createIndex("isActiveIdx","isActive",{unique:!1}),o.createIndex("updatedAtIdx","updatedAt",{unique:!1}));let a;t.objectStoreNames.contains("payments")?a=n.objectStore("payments"):(a=t.createObjectStore("payments",{keyPath:"id",autoIncrement:!0}),a.createIndex("investIdIdx","investId",{unique:!1}),a.createIndex("updatedAtIdx","updatedAt",{unique:!1})),a&&!a.indexNames.contains("isPayedIdx")&&a.createIndex("isPayedIdx","isPayed",{unique:!1})},blocked(){console.log("База данных заблокирована другой вкладкой")},blocking(){console.log("Эта вкладка блокирует обновление базы данных в другой вкладке")},terminated(){console.log("База данных была неожиданно закрыта")}})),W}async function A(t={}){const n=(await j()).transaction("payments").objectStore("payments");return t.id!==void 0?n.index("investIdIdx").getAll(t.id):t.updatedAt!==void 0?n.index("updatedAtIdx").getAll(IDBKeyRange.lowerBound(t.updatedAt)):t.isPayed!==void 0?n.index("isPayedIdx").getAll(t.isPayed):n.getAll()}async function Pe(t,s,r,n){const i=(await j()).transaction("payments","readwrite").objectStore("payments"),u={investId:t,money:Math.round(s*r),paymentDate:n,isPayed:0,updatedAt:new Date};return i.add(u)}async function le(t){const n=(await j()).transaction("payments","readwrite").objectStore("payments"),o=await n.get(t);if(!o)throw new Error("Payment not found");return o.isPayed=1,o.updatedAt=new Date,n.put(o)}async function Re(t,s){const o=(await j()).transaction(["payments"],"readwrite").objectStore("payments"),a=await o.get(t);if(!a)throw new Error("Платеж не найден");const i={...a,...s,updatedAt:new Date},u=await o.put(i);return window.dispatchEvent(new CustomEvent("fetchInvests")),u}async function G(t={}){const n=(await j()).transaction("invests").objectStore("invests");return t.filterOnlyActive===1?n.index("isActiveIdx").getAll(1):t.updatedAt!==void 0?n.index("updatedAtIdx").getAll(IDBKeyRange.lowerBound(t.updatedAt)):n.getAll()}async function Fe(t,s,r){const a=(await j()).transaction("invests","readwrite").objectStore("invests"),i={money:t,incomeRatio:s,createdDate:r,closedDate:null,isActive:1,updatedAt:new Date};return a.add(i)}async function ke(t){const n=(await j()).transaction("invests","readwrite").objectStore("invests"),o=await n.get(t);if(!o)throw new Error("Invest not found");return o.isActive=0,o.closedDate=new Date,o.updatedAt=new Date,n.put(o)}async function Ae(t,s){const r=s.money!==void 0?await A({id:t,isPayed:0}):[],o=(await j()).transaction(["invests","payments"],"readwrite"),a=o.objectStore("invests"),i=await a.get(t);if(!i)throw new Error("Инвестиция не найдена");const u={...i,...s,updatedAt:new Date};if(await a.put(u),s.money!==void 0){const c=o.objectStore("payments");for(const p of r){const l={...p,money:s.money*(i.incomeRatio||X),updatedAt:new Date};await c.put(l)}}return await o.done,window.dispatchEvent(new CustomEvent("fetchInvests")),t}const Q="https://perkin.alwaysdata.net/money/api";class M extends Error{constructor(s,r,n){super(s),this.status=r,this.statusText=n,this.name="ApiError"}}const oe={retries:3,retryDelay:1e3};async function de(t,s={}){const{retries:r=oe.retries,retryDelay:n=oe.retryDelay,...o}=s;let a=null;for(let i=0;i<=r;i++)try{const u=localStorage.getItem("token");if(!u)throw new M("Токен не найден",401);const c=await fetch(Q+t,{...o,headers:{"Content-Type":"application/json",Authorization:`Bearer ${u}`,...o.headers}});if(!c.ok){const l=new M(`HTTP ошибка: ${c.status}`,c.status,c.statusText);throw c.status===401?(f.error("Сессия истекла. Пожалуйста, авторизуйтесь заново"),l):(c.status<500&&c.status!==429,l)}return await c.json()}catch(u){if(a=u,i===r||u instanceof M&&u.status&&u.status<500&&u.status!==429){const c=u instanceof M?u.message:"Произошла сетевая ошибка";throw f.error(c),u}await new Promise(c=>setTimeout(c,n*(i+1)))}throw a||new Error("Неизвестная ошибка")}async function $e(t,s={}){return de(t,{method:"GET",...s})}async function Be(t,s,r={}){return de(t,{method:"POST",body:JSON.stringify(s),...r})}const X=.05;async function ue(){const t=await G({filterOnlyActive:1});if(t.length)for(const s of t){let r=s.createdDate;const o=[...await A({id:s.id})].sort((v,w)=>v.paymentDate.getTime()-w.paymentDate.getTime()),a=o.length>0?o[o.length-1]:null;if(a&&!a.isPayed)continue;a&&(r=a.paymentDate);const i=s.createdDate.getDate(),u=r.getMonth(),c=r.getFullYear();let p=u+1,l=c;p>11&&(p=0,l+=1);const d=new Date(l,p+1,0).getDate(),h=i>d?d:i,y=new Date(l,p,h,0,0,0,0);await Pe(s.id,s.money,s.incomeRatio||X,y)}}async function me(t,s=!1){const n=(await j()).transaction(["invests","payments"],"readwrite"),o=n.objectStore("invests"),a=n.objectStore("payments");s&&(await o.clear(),await a.clear());for(const i of t.invests){const u={...i,createdDate:new Date(i.createdDate),updatedAt:new Date(i.updatedAt),closedDate:i.closedDate?new Date(i.closedDate):void 0};await o.put(u)}for(const i of t.payments){const u={...i,paymentDate:new Date(i.paymentDate),updatedAt:new Date(i.updatedAt)};await a.put(u)}}async function Te(){const t=await G(),s=await A(),r=JSON.stringify({invests:t,payments:s});try{await navigator.clipboard.writeText(r),f.success("Данные скопированы в буфер обмена")}catch{f.error("Не удалось скопировать данные в буфер обмена")}}async function fe(){if(!localStorage.getItem("token"))return;const t=localStorage.getItem("lastSyncDate")||"";f.info("Получаю обновления...");const s=await $e(`/updates?since=${t}`);if(s.status==="success"){const r={invests:s.invests||[],payments:s.payments||[]};await me(r),f.success("Обновления успешно применены"),window.dispatchEvent(new CustomEvent("fetchInvests"))}else s.status==="no_updates"?f.info("Обновлений нет"):f.warn(s.status);localStorage.setItem("lastSyncDate",new Date().toISOString())}async function $(){if(!localStorage.getItem("token"))return;const t=localStorage.getItem("lastSyncDate");let s={},r={};t&&(s={updatedAt:new Date(t)},r={updatedAt:new Date(t)});const n=await G(s),o=await A(r);if(!n.length&&!o.length)return;const a={invests:n,payments:o},i=f.info("Отправляю данные...",{autoClose:!1});try{const u=await Be("/update",a);f.done(i),u.status==="success"&&f.success("Новые данные успешно отправлены на сервер")}catch{f.done(i)}}const pe=m.createContext(void 0),Me=({children:t})=>{const[s,r]=m.useState(null),n=a=>{localStorage.setItem("token",a);const i=ne(a);r(i)},o=()=>{localStorage.removeItem("token"),r(null)};return m.useEffect(()=>{const a=localStorage.getItem("token");if(a)try{const i=ne(a);r(i)}catch(i){console.error("Ошибка при декодировании JWT",i),o()}},[]),m.useEffect(()=>{s&&fe().then(()=>{window.dispatchEvent(new CustomEvent("fetchInvests"))}).catch(a=>{console.error("Ошибка при синхронизации:",a)})},[s]),e.jsx(pe.Provider,{value:{user:s,login:n,logout:o},children:t})},U=()=>{const t=m.useContext(pe);if(!t)throw new Error("useUser должен использоваться внутри UserProvider");return t},qe="_menuContainer_1544v_1",Oe="_menuButton_1544v_8",Le="_menuDropdownContent_1544v_16",V={menuContainer:qe,menuButton:Oe,menuDropdownContent:Le},Ge="_menuButton_nj68m_1",Ue={menuButton:Ge},S=({onClick:t,children:s})=>e.jsx("button",{className:Ue.menuButton,type:"button",onClick:t,children:s}),Je="_userName_1mfy7_1",We={userName:Je},Ve=()=>{const{user:t}=U();return e.jsx("div",{className:We.userName,children:t?t.username:""})},Ye="_importForm_1loee_1",ze="_formGroup_1loee_15",He="_errorInput_1loee_40",Ke="_errorText_1loee_44",Qe="_formActions_1loee_50",Y={importForm:Ye,formGroup:ze,errorInput:He,errorText:Ke,formActions:Qe},Xe=({onSuccess:t})=>{const[s,r]=m.useState(""),n=async o=>{o.preventDefault();const a=s.trim();try{const i=JSON.parse(a);await me(i,!0),f.success("Импорт завершен"),t(),window.dispatchEvent(new CustomEvent("fetchInvests"))}catch{f.error("Не удалось распарсить данные")}};return e.jsxs("form",{className:Y.importForm,onSubmit:n,children:[e.jsx("h2",{children:"Импорт"}),e.jsxs("div",{className:Y.formGroup,children:[e.jsx("label",{htmlFor:"import-string",children:"JSON:"}),e.jsx("textarea",{rows:10,id:"import-string",value:s,onChange:o=>r(o.target.value),required:!0})]}),e.jsx("div",{className:Y.formActions,children:e.jsx("button",{type:"submit",children:"Импортировать"})})]})},Ze="_overlay_skzxb_1",et="_popup_skzxb_14",re={overlay:Ze,popup:et},E=({children:t,onClose:s})=>(m.useEffect(()=>{const r=n=>{n.key==="Escape"&&s()};return document.addEventListener("keydown",r),()=>document.removeEventListener("keydown",r)},[s]),e.jsx("div",{className:re.overlay,onClick:s,children:e.jsx("div",{className:re.popup,onClick:r=>r.stopPropagation(),children:t})})),tt="_loginForm_1vymo_1",st="_formGroup_1vymo_15",nt="_errorInput_1vymo_38",ot="_errorText_1vymo_42",rt="_formActions_1vymo_48",I={loginForm:tt,formGroup:st,errorInput:nt,errorText:ot,formActions:rt},at=({onSuccess:t})=>{const{login:s}=U(),[r,n]=m.useState(""),[o,a]=m.useState(""),[i,u]=m.useState({}),c=async l=>{if(l.preventDefault(),u({}),!r||!o){f.error("Заполните все поля");return}try{const d=await fetch(`${Q}/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:r,password:o})});if(!d.ok){const y=await d.json();if(y.error==="invalid_credentials"){f.error("Неверный email или пароль");return}if(y.error==="validation_errors"){u(y.errors);return}throw new Error(y.message||"Ошибка при входе")}const{token:h}=await d.json();s(h),f.success("Вход выполнен успешно"),t()}catch(d){f.error(`Ошибка: ${d instanceof Error?d.message:"Неизвестная ошибка"}`)}},p=l=>{var d;return((d=i[l])==null?void 0:d.length)>0?i[l][0]:""};return e.jsxs("form",{className:I.loginForm,onSubmit:c,children:[e.jsx("h2",{children:"Вход"}),e.jsxs("div",{className:I.formGroup,children:[e.jsx("label",{htmlFor:"email",children:"Email:"}),e.jsx("input",{type:"email",id:"email",value:r,onChange:l=>n(l.target.value),className:i.email?I.errorInput:"",required:!0}),p("email")&&e.jsx("div",{className:I.errorText,children:p("email")})]}),e.jsxs("div",{className:I.formGroup,children:[e.jsx("label",{htmlFor:"password",children:"Пароль:"}),e.jsx("input",{type:"password",id:"password",value:o,onChange:l=>a(l.target.value),className:i.password?I.errorInput:"",required:!0}),p("password")&&e.jsx("div",{className:I.errorText,children:p("password")})]}),e.jsx("div",{className:I.formActions,children:e.jsx("button",{type:"submit",children:"Войти"})})]})},it="_registerForm_4l4og_1",ct="_formGroup_4l4og_15",lt="_errorInput_4l4og_38",dt="_errorText_4l4og_42",ut="_formActions_4l4og_48",g={registerForm:it,formGroup:ct,errorInput:lt,errorText:dt,formActions:ut},mt=({onSuccess:t})=>{const{login:s}=U(),[r,n]=m.useState(""),[o,a]=m.useState(""),[i,u]=m.useState(""),[c,p]=m.useState(""),[l,d]=m.useState({}),h=async v=>{if(v.preventDefault(),d({}),!r||!o||!i||!c){f.error("Заполните все поля");return}if(i!==c){d({confirmPassword:["Пароли не совпадают"]});return}try{const w=await fetch(`${Q}/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:r,username:o,password:i})});if(!w.ok){const b=await w.json();if(b.error==="user_exists"){f.error("Такой пользователь уже существует");return}if(b.error==="validation_errors"){d(b.errors);return}throw new Error(b.message||"Ошибка при регистрации")}const{token:C}=await w.json();s(C),f.success("Регистрация выполнена успешно"),t()}catch(w){f.error(`Ошибка: ${w instanceof Error?w.message:"Неизвестная ошибка"}`)}},y=v=>{var w;return((w=l[v])==null?void 0:w.length)>0?l[v][0]:""};return e.jsxs("form",{className:g.registerForm,onSubmit:h,children:[e.jsx("h2",{children:"Регистрация"}),e.jsxs("div",{className:g.formGroup,children:[e.jsx("label",{htmlFor:"email",children:"Email:"}),e.jsx("input",{type:"email",id:"email",value:r,onChange:v=>n(v.target.value),className:l.email?g.errorInput:"",required:!0}),y("email")&&e.jsx("div",{className:g.errorText,children:y("email")})]}),e.jsxs("div",{className:g.formGroup,children:[e.jsx("label",{htmlFor:"username",children:"Имя пользователя:"}),e.jsx("input",{type:"text",id:"username",value:o,onChange:v=>a(v.target.value),className:l.username?g.errorInput:"",required:!0}),y("username")&&e.jsx("div",{className:g.errorText,children:y("username")})]}),e.jsxs("div",{className:g.formGroup,children:[e.jsx("label",{htmlFor:"password",children:"Пароль:"}),e.jsx("input",{type:"password",id:"password",value:i,onChange:v=>u(v.target.value),className:l.password?g.errorInput:"",required:!0}),y("password")&&e.jsx("div",{className:g.errorText,children:y("password")})]}),e.jsxs("div",{className:g.formGroup,children:[e.jsx("label",{htmlFor:"confirmPassword",children:"Подтвердите пароль:"}),e.jsx("input",{type:"password",id:"confirmPassword",value:c,onChange:v=>p(v.target.value),className:l.confirmPassword?g.errorInput:"",required:!0}),y("confirmPassword")&&e.jsx("div",{className:g.errorText,children:y("confirmPassword")})]}),e.jsx("div",{className:g.formActions,children:e.jsx("button",{type:"submit",children:"Зарегистрироваться"})})]})},ft="_settingsForm_1wtig_1",pt="_formGroup_1wtig_15",yt="_buttonGroup_1wtig_38",ht="_saveButton_1wtig_44",vt="_logoutButton_1wtig_44",wt="_confirmButton_1wtig_44",gt="_cancelButton_1wtig_44",xt="_settingsButton_1wtig_44",_t="_testButton_1wtig_44",jt="_confirmLogout_1wtig_71",bt="_notificationStatus_1wtig_100",It="_notificationButtons_1wtig_108",N={settingsForm:ft,formGroup:pt,buttonGroup:yt,saveButton:ht,logoutButton:vt,confirmButton:wt,cancelButton:gt,settingsButton:xt,testButton:_t,confirmLogout:jt,notificationStatus:bt,notificationButtons:It},ae=async()=>{if(!("serviceWorker"in navigator)){console.error("Service Worker не поддерживается");return}try{const t=await navigator.serviceWorker.ready;if(!t.active){console.log("Service Worker не активен");return}t.active.postMessage({type:"check-debts"}),console.log("Запрос на проверку долгов отправлен")}catch(t){console.error("Ошибка при проверке долгов:",t)}},St=async()=>{if(!("Notification"in window))return console.error("Уведомления не поддерживаются"),!1;try{return await Notification.requestPermission()==="granted"}catch(t){return console.error("Ошибка при запросе разрешения на уведомления:",t),!1}},Dt=()=>{const[t,s]=m.useState(Notification.permission||"default"),r=async()=>{await St()?(s("granted"),f.success("Разрешение на уведомления получено"),await ae()):(s("denied"),f.error("Разрешение на уведомления не получено"))},n=async()=>{await ae(),f.info("Запрос на проверку долгов отправлен")};return e.jsxs("div",{className:N.settingsForm,children:[e.jsx("h2",{children:"Настройки"}),e.jsxs("div",{className:N.formGroup,children:[e.jsx("label",{children:"Уведомления"}),e.jsxs("div",{className:N.notificationStatus,children:["Статус: ",t==="granted"?"Разрешены":t==="denied"?"Заблокированы":"Не запрошены"]}),e.jsxs("div",{className:N.notificationButtons,children:[e.jsx("button",{onClick:r,disabled:t==="denied",className:N.settingsButton,children:t==="granted"?"Уведомления разрешены":"Разрешить уведомления"}),t==="granted"&&e.jsx("button",{onClick:n,className:N.testButton,children:"Проверить долги"})]})]})]})},Nt=()=>{const{user:t,logout:s}=U(),[r,n]=m.useState(!1),o=m.useRef(null),a=m.useRef(null);m.useEffect(()=>{const x=B=>{a.current&&!a.current.contains(B.target)&&o.current&&!o.current.contains(B.target)&&n(!1)};return document.addEventListener("click",x),()=>{document.removeEventListener("click",x)}},[]);const i=x=>{x.stopPropagation(),n(B=>!B)},[u,c]=m.useState(!1),[p,l]=m.useState(!1),[d,h]=m.useState(!1),[y,v]=m.useState(!1),w=async()=>{try{await Te(),f.success("Данные успешно экспортированы")}catch(x){f.error(`Ошибка экспорта: ${x instanceof Error?x.message:"Неизвестная ошибка"}`)}},C=()=>{n(!1),c(!0)},b=()=>{n(!1),v(!0)},P=async()=>{try{localStorage.setItem("lastSyncDate",""),await fe(),f.success("Данные успешно синхронизированы")}catch(x){f.error(`Ошибка синхронизации: ${x instanceof Error?x.message:"Неизвестная ошибка"}`)}},ye=()=>{s(),f.success("Вы успешно вышли")};return e.jsxs("div",{className:V.menuContainer,children:[e.jsx(Ve,{}),e.jsx("button",{className:V.menuButton,ref:o,onClick:i,children:"☰"}),r&&e.jsxs("div",{className:V.menuDropdownContent,ref:a,children:[e.jsx(S,{onClick:w,children:"Экспорт"}),e.jsx(S,{onClick:C,children:"Импорт"}),e.jsx(S,{onClick:b,children:"Настройки"}),t?e.jsxs(e.Fragment,{children:[e.jsx(S,{onClick:P,children:"Обновить данные"}),e.jsx(S,{onClick:ye,children:"Выход"})]}):e.jsxs(e.Fragment,{children:[e.jsx(S,{onClick:()=>h(!0),children:"Регистрация"}),e.jsx(S,{onClick:()=>l(!0),children:"Авторизация"})]})]}),p&&e.jsx(E,{onClose:()=>l(!1),children:e.jsx(at,{onSuccess:()=>{l(!1),n(!1)}})}),d&&e.jsx(E,{onClose:()=>h(!1),children:e.jsx(mt,{onSuccess:()=>{h(!1),n(!1)}})}),y&&e.jsx(E,{onClose:()=>v(!1),children:e.jsx(Dt,{})}),u&&e.jsx(E,{onClose:()=>c(!1),children:e.jsx(Xe,{onSuccess:()=>c(!1)})})]})},Et="_addInvestForm_xb664_1",Ct="_moneyRow_xb664_5",Pt="_dateRow_xb664_27",Rt="_buttonRow_xb664_37",q={addInvestForm:Et,moneyRow:Ct,dateRow:Pt,buttonRow:Rt},Ft=()=>{const t=m.useRef(null),[s,r]=m.useState(0),[n,o]=m.useState(.025),[a,i]=m.useState(),u=async c=>{var p;if(c.preventDefault(),!s||!n||!a){f.error("Заполните все поля");return}a.setHours(0,0,0);try{const l=await Fe(s,n,a);Number.isInteger(l)?(await ue(),await $(),(p=t.current)==null||p.reset(),f.success("Инвестиция добавлена"),window.dispatchEvent(new CustomEvent("fetchInvests"))):f.error("Не удалось добавить инвестицию")}catch(l){f.error(`Ошибка: ${l instanceof Error?l.message:"Неизвестная ошибка"}`)}};return e.jsxs("form",{className:q.addInvestForm,ref:t,onSubmit:u,children:[e.jsxs("div",{className:q.moneyRow,children:[e.jsx("input",{type:"text",placeholder:"Сколько инвестируем",onChange:c=>r(parseFloat(c.target.value)),required:!0}),e.jsxs("select",{onChange:c=>o(parseFloat(c.target.value)),required:!0,children:[e.jsx("option",{value:"0.025",children:"2.5%"}),e.jsx("option",{value:"0.05",children:"5%"})]})]}),e.jsx("div",{className:q.dateRow,children:e.jsx("input",{type:"date",placeholder:"Дата инвестиции",onChange:c=>i(new Date(c.target.value)),onClick:c=>c.currentTarget.showPicker(),required:!0})}),e.jsx("div",{className:q.buttonRow,children:e.jsx("button",{type:"submit",children:"Добавить"})})]})},kt="_dataFilter_1s026_1",At="_filterItem_1s026_6",z={dataFilter:kt,filterItem:At},$t=({activeFilter:t,setActiveFilter:s,showPayed:r,setShowPayed:n})=>e.jsxs("div",{className:z.dataFilter,children:[e.jsx("div",{className:z.filterItem,children:e.jsxs("label",{children:[e.jsx("input",{type:"checkbox",checked:t,onChange:()=>s(!t)}),"С закрытыми"]})}),e.jsx("div",{className:z.filterItem,children:e.jsxs("label",{children:[e.jsx("input",{type:"checkbox",checked:r,onChange:()=>n(!r)}),"С оплаченными"]})})]}),Bt="_dataList_5dlll_1",Tt="_dataItem_5dlll_7",ie={dataList:Bt,dataItem:Tt},Mt="_dataItem_1wxo7_1",qt="_even_1wxo7_12",Ot="_closed_1wxo7_16",Lt="_itemMoney_1wxo7_20",Gt="_itemActions_1wxo7_24",Ut="_investCloseButton_1wxo7_30",Jt="_investEditButton_1wxo7_31",D={dataItem:Mt,even:qt,closed:Ot,itemMoney:Lt,itemActions:Gt,investCloseButton:Ut,investEditButton:Jt},Wt="_dataItem_13v5n_1",Vt="_emptyCell_13v5n_10",Yt="_even_13v5n_14",zt="_debt_13v5n_18",Ht="_payed_13v5n_22",Kt="_itemMoney_13v5n_26",Qt="_itemActions_13v5n_30",Xt="_paymentCloseButton_13v5n_36",Zt="_paymentEditButton_13v5n_37",_={dataItem:Wt,emptyCell:Vt,even:Yt,debt:zt,payed:Ht,itemMoney:Kt,itemActions:Qt,paymentCloseButton:Xt,paymentEditButton:Zt},es=new Intl.NumberFormat("default",{style:"currency",currency:"RUB",useGrouping:!0,maximumSignificantDigits:9,currencyDisplay:"symbol"}),K=t=>{if(!t)return"";if(!(t instanceof Date))return t;let s=t.getFullYear()+"",r=t.toLocaleString("default",{month:"short"}).replace(".",""),n=t.getDate()+"";return t.getDate()<10&&(n="0"+n),`${s}-${r}-${n}`},Z=t=>es.format(t).replace(/RUB\s*([0-9,.-]+)/,"$1 ₽"),ts="_editPaymentForm_17xt4_1",ss="_formRow_17xt4_9",ns="_buttonRow_17xt4_37",F={editPaymentForm:ts,formRow:ss,buttonRow:ns},os=t=>{const s=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),n=String(t.getDate()).padStart(2,"0");return`${s}-${r}-${n}`},rs=({payment:t,onClose:s})=>{const r=m.useRef(null),[n,o]=m.useState(t.money),[a,i]=m.useState(t.paymentDate),[u,c]=m.useState(t.isPayed),p=async l=>{if(l.preventDefault(),!n||n<=0||!a){f.error("Заполните все поля");return}try{await Re(t.id,{money:n,paymentDate:a,isPayed:u}),await $(),f.success("Платёж обновлен"),s()}catch(d){f.error(`Ошибка: ${d instanceof Error?d.message:"Неизвестная ошибка"}`)}};return e.jsxs("form",{className:F.editPaymentForm,ref:r,onSubmit:p,children:[e.jsxs("div",{className:F.formRow,children:[e.jsx("label",{children:"Сумма:"}),e.jsx("input",{type:"number",value:n,onChange:l=>o(parseFloat(l.target.value)),required:!0})]}),e.jsxs("div",{className:F.formRow,children:[e.jsx("label",{children:"Дата платежа:"}),e.jsx("input",{type:"date",value:os(a),onChange:l=>{const d=l.target.value;if(d){const[h,y,v]=d.split("-"),w=parseInt(h,10),C=parseInt(y,10)-1,b=parseInt(v,10),P=new Date;P.setFullYear(w,C,b),P.setHours(0,0,0,0),i(P)}},required:!0})]}),e.jsxs("div",{className:F.formRow,children:[e.jsx("label",{children:"Статус:"}),e.jsxs("select",{value:u,onChange:l=>c(parseInt(l.target.value)),children:[e.jsx("option",{value:0,children:"Не оплачен"}),e.jsx("option",{value:1,children:"Оплачен"})]})]}),e.jsxs("div",{className:F.buttonRow,children:[e.jsx("button",{type:"submit",children:"Сохранить"}),e.jsx("button",{type:"button",onClick:s,children:"Отмена"})]})]})},as=({payment:t,isEven:s,isDebt:r,onClosePayment:n})=>{const[o,a]=m.useState(!1),i=async u=>{try{const c=await le(u);Number.isInteger(c)&&c===u?(f.success("Долг оплачен"),await ue(),n(),await $()):f.error("Не удалось оплатить платеж")}catch(c){f.error(`Ошибка: ${c instanceof Error?c.message:"Неизвестная ошибка"}`)}};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:`${_.dataItem} ${s?_.even:""} ${r?_.debt:""} ${t.isPayed==1?_.payed:""}`,children:[e.jsx("div",{className:_.emptyCell}),e.jsx("div",{children:K(t.paymentDate)}),e.jsx("div",{className:_.itemMoney,children:Z(t.money)}),e.jsxs("div",{className:_.itemActions,children:[e.jsx("button",{className:_.paymentEditButton,title:"Редактировать платёж",onClick:()=>a(!0),children:"✎"}),t.isPayed==0&&e.jsx("button",{className:_.paymentCloseButton,title:"Оплата произведена",onClick:()=>i(t.id),children:"✓"})]})]}),o&&e.jsx(E,{onClose:()=>a(!1),children:e.jsx(rs,{payment:t,onClose:()=>{a(!1),n()}})})]})},is="_editInvestForm_xk5rx_1",cs="_formRow_xk5rx_9",ls="_buttonRow_xk5rx_37",O={editInvestForm:is,formRow:cs,buttonRow:ls},ds=t=>t.toISOString().split("T")[0],us=({invest:t,onClose:s})=>{const r=m.useRef(null),[n,o]=m.useState(t.money),[a,i]=m.useState(t.createdDate),u=async c=>{if(c.preventDefault(),!n||!a){f.error("Заполните все поля");return}try{await Ae(t.id,{money:n,createdDate:a}),await $(),f.success("Инвестиция обновлена"),s()}catch(p){f.error(`Ошибка: ${p instanceof Error?p.message:"Неизвестная ошибка"}`)}};return e.jsxs("form",{className:O.editInvestForm,ref:r,onSubmit:u,children:[e.jsxs("div",{className:O.formRow,children:[e.jsx("label",{htmlFor:"money-input",children:"Сумма:"}),e.jsx("input",{id:"money-input",type:"number",value:n,onChange:c=>o(parseFloat(c.target.value)),required:!0})]}),e.jsxs("div",{className:O.formRow,children:[e.jsx("label",{htmlFor:"date-input",children:"Дата создания:"}),e.jsx("input",{id:"date-input",type:"date",value:ds(a),onChange:c=>i(new Date(c.target.value)),required:!0})]}),e.jsxs("div",{className:O.buttonRow,children:[e.jsx("button",{type:"submit",children:"Сохранить"}),e.jsx("button",{type:"button",onClick:s,children:"Отмена"})]})]})},ms=({invest:t,isEven:s,payments:r,onRefreshData:n})=>{const o=new Date,[a,i]=m.useState(!1),u=async c=>{if(!(!c||!confirm("Точно закрыть?")))try{const p=await ke(c);if(Number.isInteger(p)&&p===c){for(const l of r)if(!l.isPayed&&l.id!==void 0)try{const d=await le(l.id);Number.isInteger(d)&&d===l.id?f.info("Долг автоматически оплачен"):f.error("Не удалось закрыть активный долг")}catch(d){f.error(`Ошибка: ${d instanceof Error?d.message:"Неизвестная ошибка"}`)}f.success("Инвестиция закрыта"),n(),await $()}else f.error("Не удалось закрыть инвестицию")}catch(p){f.error(`Ошибка: ${p instanceof Error?p.message:"Неизвестная ошибка"}`)}};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:`${D.dataItem} ${s?D.even:""} ${t.closedDate?D.closed:""}`,children:[e.jsx("div",{children:K(t.createdDate)}),e.jsx("div",{children:K(t.closedDate)}),e.jsxs("div",{className:D.itemMoney,children:[Z(t.money)," (",100*(t.incomeRatio||X),"%)"]}),e.jsx("div",{className:D.itemActions,children:t.isActive==1&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:D.investEditButton,title:"Редактировать инвестицию",onClick:()=>i(!0),children:"✎"}),e.jsx("button",{className:D.investCloseButton,title:"Закрыть инвестицию",onClick:()=>t.id!==void 0&&u(t.id),children:"✕"})]})})]}),a&&e.jsx(E,{onClose:()=>i(!1),children:e.jsx(us,{invest:t,onClose:()=>{i(!1),n()}})}),r.map(c=>c.id!==void 0?e.jsx(as,{payment:c,isEven:s,isDebt:!c.isPayed&&c.paymentDate<o,onClosePayment:n},c.id):null)]})},fs="_curDateItem_70h4h_1",ps={curDateItem:fs},ce=()=>e.jsx("div",{className:ps.curDateItem}),ys="_dataItem_11qg2_1",hs="_itemMoney_11qg2_12",vs="_itemActions_11qg2_16",ws="_debt_11qg2_22",L={dataItem:ys,itemMoney:hs,itemActions:vs,debt:ws},H=({amount:t,title:s,isDebt:r=!1})=>e.jsxs("div",{className:`${L.dataItem} ${r?L.debt:""}`,children:[e.jsx("div",{children:s}),e.jsx("div",{}),e.jsx("div",{className:L.itemMoney,children:Z(t)}),e.jsx("div",{className:L.itemActions})]}),gs=({invests:t,showPayed:s})=>{const r=new Date,n=r.getDate(),[o,a]=m.useState({});m.useEffect(()=>{(async()=>{const d={};for(const h of t)if(h.id!==void 0){const v=(await A({id:h.id})).filter(w=>s||!w.isPayed);d[h.id]=v}a(d)})().catch(d=>{console.error("Ошибка при загрузке платежей:",d)})},[t,s]);const i=m.useMemo(()=>t.reduce((l,d)=>l+(d.isActive?d.money:0),0),[t]),u=m.useMemo(()=>t.reduce((l,d)=>l+(d.isActive?d.money*(d.incomeRatio||.05):0),0),[t]),c=m.useMemo(()=>{let l=0;return Object.entries(o).forEach(([,d])=>{d.forEach(h=>{!h.isPayed&&h.paymentDate<r&&(l+=h.money)})}),l},[o,r]),p=m.useMemo(()=>t.map((l,d)=>{const h=l.createdDate.getDate();let y=[];if(d===0&&h>=n&&y.push(e.jsx(ce,{},"current-date-first")),l.id!==void 0){const v=o[l.id]||[];y.push(e.jsx(ms,{invest:l,isEven:d%2===0,payments:v,onRefreshData:()=>window.dispatchEvent(new CustomEvent("fetchInvests"))},l.id))}return d<t.length-1&&h<n&&t[d+1].createdDate.getDate()>=n&&y.push(e.jsx(ce,{},"current-date-middle")),y}).flat(),[t,o,n]);return e.jsxs("div",{className:ie.dataList,children:[e.jsx("div",{children:e.jsxs("div",{className:ie.dataItem,children:[e.jsx("div",{children:"Создано"}),e.jsx("div",{children:"Закрыто/Оплата"}),e.jsx("div",{children:"Сумма"}),e.jsx("div",{children:"Действия"})]})}),e.jsxs("div",{children:[p,e.jsx(H,{title:"Итого",amount:i}),e.jsx(H,{title:"Прибыль",amount:u}),c>0&&e.jsx(H,{title:"Долг",amount:c,isDebt:!0})]})]})},xs="_container_1b0su_29",_s={container:xs},js=()=>{const[t,s]=m.useState(!1),[r,n]=m.useState(!1),[o,a]=m.useState([]),i=m.useCallback(async()=>{const p=(await G({filterOnlyActive:t?0:1})).sort((l,d)=>{const h=l.createdDate.getDate(),y=d.createdDate.getDate();return h-y});a(p)},[t]);return m.useEffect(()=>(i().catch(u=>{console.error("Ошибка в fetchInvests:",u)}),window.addEventListener("fetchInvests",i),()=>window.removeEventListener("fetchInvests",i)),[i]),e.jsxs(Me,{children:[e.jsx(ge,{position:"top-center",closeButton:!1,autoClose:3e3,hideProgressBar:!1,newestOnTop:!0,transition:xe,theme:"dark"}),e.jsxs("div",{className:_s.container,children:[e.jsx("h1",{children:"Инвестиции"}),e.jsx(Nt,{}),e.jsx(Ft,{}),e.jsx($t,{activeFilter:t,setActiveFilter:s,showPayed:r,setShowPayed:n}),e.jsx(gs,{invests:o,showPayed:r})]})]})};Ie.createRoot(document.getElementById("root")).render(e.jsx(m.StrictMode,{children:e.jsx(js,{})}));"serviceWorker"in navigator&&window.addEventListener("load",async()=>{var t,s,r;try{const n=await navigator.serviceWorker.register("/money3/service-worker.js",{updateViaCache:"none"});if(console.log("ServiceWorker успешно зарегистрирован:",n.scope),n.addEventListener("updatefound",()=>{const o=n.installing;o&&(console.log("Обнаружена новая версия ServiceWorker"),o.addEventListener("statechange",()=>{o.state==="installed"&&navigator.serviceWorker.controller&&(console.log("Новый Service Worker установлен и готов к использованию"),confirm("Доступна новая версия приложения. Обновить сейчас?")&&window.location.reload())}))}),"Notification"in window){const o=await Notification.requestPermission();console.log("Разрешение на уведомления:",o)}if(n.periodicSync)try{(await navigator.permissions.query({name:"periodic-background-sync"})).state==="granted"?(await n.periodicSync.register("check-debts",{minInterval:20*60*60*1e3}),console.log("Периодическая синхронизация успешно зарегистрирована")):(console.log("Нет разрешения на периодическую синхронизацию"),(t=n.active)==null||t.postMessage({type:"check-debts"}))}catch(o){console.error("Ошибка при регистрации периодической синхронизации:",o),(s=n.active)==null||s.postMessage({type:"check-debts"})}else if(console.log("Периодическая синхронизация не поддерживается"),(r=n.active)==null||r.postMessage({type:"check-debts"}),n.sync)try{await n.sync.register("check-debts"),console.log("Фоновая синхронизация успешно зарегистрирована")}catch(o){console.error("Ошибка при регистрации фоновой синхронизации:",o)}}catch(n){console.error("Ошибка при регистрации ServiceWorker:",n)}});
